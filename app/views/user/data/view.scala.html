@()(implicit request: play.api.mvc.RequestHeader)
@main("mutation_table") {
    @*为琪哥的sortable *@
    <script src="@routes.Assets.at("dist/bootstrap-advanced-sortable/js/bootstrap-advanced-sortable.js")" type="text/javascript"></script>
    <link rel="stylesheet" media="screen" href="@routes.Assets.at("dist/bootstrap-advanced-sortable/css/bootstrap-advanced-sortable.css")">
    <script src="@routes.Assets.at("highchart8.2.0/highcharts.js")"></script>

    <style>
            .form-check-label {
                cursor: pointer;
            }

            .bootstrap-table .fixed-table-container .table td {
                white-space: nowrap;
            }

            .modal-content {
                right: 200px;
            }

            .form-check-label {
                min-height: 29px;
                margin-left: 1.75rem;
                font-size: 1.5rem;
                line-height: 1.5;
            }

            input.form-check-input {
                margin-right: 15px;
            }



    </style>


    <div class="container">
        <div class="row">
            <div class="form-group col-sm-12">
                <h2 class="page-heading"
                style="text-align: left;
                    border-bottom: 5px solid #e9f3f4">数据一览</h2>
            </div>
        </div>

        <div id="container">
            <div class="row">
                <div class="col-md-12 stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <button class="btn btn-primary" data-toggle="modal" data-target="#staticBackdrop" style="margin-bottom: 20px">
                                请选择试剂盒
                            </button>
                        </div>
                        <table id="table" class="table table-bordered" data-advanced-sortable="true" data-pagination="true" style="width: 1200px"></table>
                    </div>
                </div>
            </div>
        </div>


        <div id="result" style="display: none">

            <div id="container1" class="col-md-12">
                <div id="containerX" class="col-md-6">

                </div>
                <div id="containertable1" class="col-md-6">
                    <table id="table1" class="table table-bordered col-md-6">

                    </table>
                </div>
            </div>

            <div id="container2" class="col-md-12">
                <div id="container" class="col-md-12">
                    <select id="test2" onchange="drawing2()" style="width: 225px">
                    </select>
                </div>
                <div class="col-md-6">
                    <div id="containerX2" style="position: relative;
                        top: 26px;">
                    </div>
                </div>
                <div class="col-md-6">
                    <table id="table2" class="table table-bordered">

                    </table>
                </div>
            </div>
        </div>


    </div>

    <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="staticBackdrop">
        <div class="modal-dialog modal-xl  modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content" style="width: 1000px">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">筛选</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position: relative;
                        top: -16px">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="height: auto">
                    <div class="col-sm-12 row" id="filter">
                        @*<div class="radio" id="radiofilter">
                        *@@*这里会填充试剂盒名称*@@*
                        </div>*@
                    </div>
                </div>
                @*分割线*@
                <hr style="margin-bottom: 39px">
                <div class="modal-body" style="height: 460px;
                    padding: 0px">
                    <div class="col-sm-12 row" id="showcolumns" style=" margin-top: -21px;
                        padding-left: 15px;
                        position: relative;
                        left: 15px;
                    ">
                        @*这里会填充试剂盒的内容*@
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="confirm1()">确认</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>


    <script>
            var datavalue = [
                {id: 'hugo_symbol', text: 'Hugo_Symbol'},
                {id: 'entrez_gene_id', text: 'Entrez_Gene_Id'},
                {id: "center", text: "Center"},
                {id: "ncbi_build", text: "NCBI_Build"},
                {id: "chromosome", text: "Chromosome"},
                {id: "start_position", text: "Start_Position"},
                {id: "end_position", text: "End_Position"},
                {id: "strand", text: "Strand"},
                {id: "consequence", text: "Consequence"},
                {id: "variant_classification", text: "Variant_Classification"},
                {id: "variant_type", text: "Variant_Type"},
                {id: "reference_allele", text: "Reference_Allele"},
                {id: "tumor_seq_allele1", text: "Tumor_Seq_Allele1"},
                {id: "tumor_seq_allele2", text: "Tumor_Seq_Allele2"},
                {id: "dbsnp_rs", text: "dbSNP_RS"},
                {id: "dbsnp_val_status", text: "dbSNP_Val_Status"},
                {id: "tumor_sample_barcode", text: "Tumor_Sample_Barcode"},
                {id: "matched_norm_sample_barcode", text: "Matched_Norm_Sample_Barcode"},
                {id: "match_norm_seq_allele1", text: "Match_Norm_Seq_Allele1"},
                {id: "match_norm_seq_allele2", text: "Match_Norm_Seq_Allele2"},
                {id: "tumor_validation_allele1", text: "Tumor_Validation_Allele1"},
                {id: "tumor_validation_allele2", text: "Tumor_Validation_Allele2"},
                {id: "match_norm_validation_allele1", text: "Match_Norm_Validation_Allele1"},
                {id: "match_norm_validation_allele2", text: "Match_Norm_Validation_Allele2"},
                {id: "verification_status", text: "Verification_Status"},
                {id: "validation_status", text: "Validation_Status"},
                {id: "mutation_status", text: "Mutation_Status"},
                {id: "sequencing_phase", text: "Sequencing_Phase"},
                {id: "sequence_source", text: "Sequence_Source"},
                {id: "validation_method", text: "Validation_Method"},
                {id: "score", text: "Score"},
                {id: "bam_file", text: "BAM_File"},
                {id: "sequencer", text: "Sequencer"},
                {id: "t_ref_count", text: "t_ref_count"},
                {id: "t_alt_count", text: "t_alt_count"},
                {id: "n_ref_count", text: "n_ref_count"},
                {id: "n_alt_count", text: "n_alt_count"},
                {id: "hgvsc", text: "HGVSc"},
                {id: "hgvsp", text: "HGVSp"},
                {id: "hgvsp_short", text: "HGVSp_Short"},
                {id: "transcript_id", text: "Transcript_ID"},
                {id: "refseq", text: "RefSeq"},
                {id: "protein_position", text: "Protein_position"},
                {id: "codons", text: "Codons"},
                {id: "hotspot", text: "Hotspot"},
                {id: "t_alt_count_percentage", text: "t_alt_count_percentage"},
            ]
            let count = 0;
            let allTotal = 0;
            $(function () {
                $("#table").bootstrapTable({
                    method: 'post',
                    url: "@userC.routes.DataController.getMutationTable()",
                    sidePagination: "server",
                    pageNumber: 1,
                    pagination: true,
                    pageList: [15],
                    pageSize: 20,
                    contentType: "application/x-www-form-urlencoded",
                    advancedSortable: true,
                    onLoadSuccess: function (data) {
                        /*   if(count ===0){
                               count ++;
                               allTotal=data.total;
                           }
                         drawing(data.total);*/
                    },
                    columns: [{
                        field: "id",
                        title: "id",
                        sortable: true,
                        searchType: "text"
                    },
                        {
                            field: "sample_id",
                            title: "sample_id",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "hugo_symbol",
                            title: "Hugo_Symbol",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "entrez_gene_id",
                            title: "Entrez_Gene_Id",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "center",
                            title: "Center",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "ncbi_build",
                            title: "NCBI_Build",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "chromosome",
                            title: "Chromosome",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "start_position",
                            title: "Start_Position",
                            sortable: true,
                            searchType: "num"
                        },
                        {
                            field: "end_position",
                            title: "End_Position",
                            sortable: true,
                            searchType: "num"
                        },
                        {
                            field: "strand",
                            title: "Strand",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "consequence",
                            title: "Consequence",
                            sortable: true,
                            searchType: "text"
                        }, {
                            field: "variant_classification",
                            title: "Variant_Classification",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "variant_type",
                            title: "Variant_Type",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "reference_allele",
                            title: "Reference_Allele",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "tumor_seq_allele1",
                            title: "Tumor_Seq_Allele1",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "tumor_seq_allele2",
                            title: "Tumor_Seq_Allele2",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "dbsnp_rs",
                            title: "dbSNP_RS",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "dbsnp_val_status",
                            title: "dbSNP_Val_Status",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "tumor_sample_barcode",
                            title: "Tumor_Sample_Barcode",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "matched_norm_sample_barcode",
                            title: "Matched_Norm_Sample_Barcode",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "match_norm_seq_allele1",
                            title: "Match_Norm_Seq_Allele1",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "match_norm_seq_allele2",
                            title: "Match_Norm_Seq_Allele2",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "tumor_validation_allele1",
                            title: "Tumor_Validation_Allele1",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "tumor_validation_allele2",
                            title: "Tumor_Validation_Allele2",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "match_norm_validation_allele1",
                            title: "Match_Norm_Validation_Allele1",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "match_norm_validation_allele2",
                            title: "Match_Norm_Validation_Allele2",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "verification_status",
                            title: "Verification_Status",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "validation_status",
                            title: "Validation_Status",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "mutation_status",
                            title: "Mutation_Status",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "sequencing_phase",
                            title: "Sequencing_Phase",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "sequence_source",
                            title: "Sequence_Source",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "validation_method",
                            title: "Validation_Method",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "score",
                            title: "Score",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "bam_file",
                            title: "BAM_File",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "sequencer",
                            title: "Sequencer",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "t_ref_count",
                            title: "t_ref_count",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "t_alt_count",
                            title: "t_alt_count",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "n_ref_count",
                            title: "n_ref_count",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "n_alt_count",
                            title: "n_alt_count",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "hgvsc",
                            title: "HGVSc",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "hgvsp",
                            title: "HGVSp",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "hgvsp_short",
                            title: "HGVSp_Short",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "transcript_ID",
                            title: "Transcript_ID",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "refseq",
                            title: "RefSeq",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "protein_position",
                            title: "Protein_position",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "codons",
                            title: "Codons",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "hotspot",
                            title: "Hotspot",
                            sortable: true,
                            searchType: "text"
                        },
                        {
                            field: "t_alt_count_percentage",
                            title: "t_alt_count_percentage",
                            sortable: true,
                            searchType: "text"
                        },
                    ]
                })
            })
    </script>

    <script>

            var drawingData = {}
            var result = ""

            function drawing() {
                let element = "<div id='content'><span id='info'>运行中 </span></div>";
                let index = layer.msg(element, {
                    icon: 16
                    , shade: 0.01,
                    time: 20000000
                });
                $("#test2").select2({data: datavalue})
                console.log(drawingData)
                $('#result').show()
                $.ajax({
                    url: "/pathology/user/data/drawing",
                    type: "post",
                    data: drawingData,
                    success: function (res) {
                        Highcharts.chart('containerX', {
                            chart: {
                                type: 'column'
                            },
                            title: {
                                text: '各条件的行数的柱状图'
                            },
                            subtitle: {
                                text: ''
                            },
                            xAxis: {
                                type: 'category'
                            },
                            yAxis: {
                                title: {
                                    text: '符合条件数据的行数'
                                }
                            },
                            legend: {
                                enabled: false
                            },
                            plotOptions: {
                                series: {
                                    borderWidth: 0,
                                    dataLabels: {
                                        enabled: true,
                                        format: '{point.y:.0f}'
                                    }
                                }
                            },
                            tooltip: {
                                headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                                pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.0f}</b> of total<br/>'
                            },
                            series: [{
                                name: '列名',
                                colorByPoint: true,
                                data: res.linerData
                            }]
                        });

                        // 制表
                        $('#table1').bootstrapTable('destroy');
                        $("#table1").bootstrapTable({
                            data: res.linerData,
                            pageNumber: 1,
                            pagination: true,
                            pageSize: 5,
                            pageList: [10],
                            contentType: "application/x-www-form-urlencoded",
                            onLoadSuccess: function (data) {

                            },
                            columns: [
                                {
                                    field: "name",
                                    title: "Name",
                                },
                                {
                                    field: "y",
                                    title: "Height",
                                },
                            ]
                        })
                        // 首次进入页面的时候，展示"Hugo_Symbol"的图和表
                        drawing2()
                        layer.close(index)
                        let target_top = $("#result").offset().top - 60;
                        $("html,body").animate({scrollTop: target_top}, 800);
                    }
                })
            }

            function drawing2() {

                var param = $("#test2").val()
                if (param == undefined) {
                    param = "hugo_symbol"
                }
                let value = JSON.parse(drawingData)
                value["param"] = param
                let json = JSON.stringify(value)
                console.log(json)
                $.ajax({
                    url: "/pathology/user/data/drawing2",
                    type: "post",
                    data: json,
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (res) {
                        Highcharts.chart('containerX2', {
                            chart: {
                                type: 'column'
                            },
                            title: {
                                text: '列的数据的分布情况'
                            },
                            subtitle: {
                                text: ''
                            },
                            xAxis: {
                                type: 'category'
                            },
                            yAxis: {
                                title: {
                                    text: '该值的出现次数占总数的百分比'
                                }
                            },
                            legend: {
                                enabled: false
                            },
                            plotOptions: {
                                series: {
                                    borderWidth: 0,
                                    dataLabels: {
                                        enabled: true,
                                        format: '{point.y:.2f}%'
                                    }
                                }
                            },
                            tooltip: {
                                headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                                pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.0f}</b> of total<br/>'
                            },
                            series: [{
                                name: '列名',
                                colorByPoint: true,
                                data: res.Result
                            }]
                        });
                        makeTable()
                    }
                })
            }


            function makeTable() {
                var param = $("#test2").val()
                if (param == undefined) {
                    param = "hugo_symbol"
                }
                let value = JSON.parse(drawingData)
                value["param"] = param
                let json = JSON.stringify(value)
                $.ajax({
                    url: "/pathology/user/data/maketable2",
                    type: "post",
                    data: json,
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (res) {
                        // 制表2
                        $('#table2').bootstrapTable('destroy');
                        $("#table2").bootstrapTable({
                            data: res.Result,
                            pageNumber: 1,
                            pagination: true,
                            pageSize: 10,
                            pageList: [10],
                            contentType: "application/x-www-form-urlencoded",
                            onLoadSuccess: function (data) {

                            },
                            columns: [
                                {
                                    field: "name",
                                    title: "Name",
                                },
                                {
                                    field: "y",
                                    title: "Height",
                                },
                            ]
                        })
                    }
                })
            }


    </script>


    <script>
            var columnsforshow = []

            function showColumns(value) {
                let v = value.toString()
                columnsforshow = []
                $("#showcolumns").empty()
                $.ajax({
                    url: "/pathology/user/data/searchKitdata",
                    type: "post",
                    data: v,
                    contentType: "text/plain; charset=utf-8",
                    success: function (res) {
                        /*  {"name":"x1xx",
                                "config":[
                                    {"param":"a","value":"hgvsc,score,center,codons,refseq,strand"},
                                    {"param":"b","value":"hgvsc,score,center,codons,refseq,strand"},
                                    {"param":"c","value":"hgvsc,score,center,codons,refseq,strand,hgvsc,score,center,codons,refseq,strand,hgvsc,score,center,codons,refseq,strand"}]
                               }
                        * */
                        let data = res.config
                        for (let i = data.length - 1; i >= 0; i--) {
                            var elem = res.config[i]
                            var kitparam = elem.param
                            var str = elem.value
                            var kitcolumns = str.split(",")
                            // 展示param   XXX:
                          /*  $("#showcolumns").append(`

                                        <div class="checkbox inline">
                                          <label>
                                        <input type="checkbox" data-name=${kitparam} name="optionsRadios2" id="optionsRadios2" value="${kitparam}" onclick="selectparams('${kitparam}')"> <b>${kitparam}</b>
                                         </label>
                                          </div>

                            `)*/
                            $("#showcolumns").append(`
                                 <button type="button" class="btn btn-primary btn-xs" style="position: relative;top: -2px" onclick="selectAll('${kitparam}')">全选</button>
                                 <button type="button" class="btn btn-primary btn-xs" style="position: relative;top: -2px" onclick="antiselectAll('${kitparam}')">全不选</button>
                                   <b style="font-size: 20px">${kitparam}:</b>
                            `)
                            $("#showcolumns").append(`&nbsp;&nbsp;`)
                            $.each(kitcolumns, (i, v) => {
                                $("#showcolumns").append(`
                                  <div class="checkbox inline" style="margin: 10px">
                                <label>
                                    <input type="checkbox" target-name=${kitparam}   value="${v}" onclick="addcolumn(this)" > ${kitcolumns[i]}
                                </label>
                                  </div>
                                `)
                            })
                            $("#showcolumns").append(`<hr style="width:auto">`)
                        }
                    }
                })
            }
            function selectAll(kitparam){
                  /* $("[target-name='" + kitparam + "']").each(function(){
                           if($(this).is(':checked')){
                               $(this).prop('checked',false)
                               columnsforshow.pop($(this).val())
                           }else{
                               $(this).prop('checked',true)
                               columnsforshow.push($(this).val())
                           }

                   })*/
                $("[target-name='" + kitparam + "']").each(function(){
                    $(this).prop('checked',true)
                    columnsforshow.push(($(this).val()))
                })

            }

            function antiselectAll(kitparam){
                $("[target-name='" + kitparam + "']").each(function(){
                    $(this).prop('checked',false)
                    columnsforshow.pop(($(this).val()))
                })
            }
            //点击复选框后触发的函数
            function addcolumn(p) {
                if($(p).is(':checked')){
                    columnsforshow.push($(p).val())
                }else{
                    columnsforshow.pop($(p).val())
                }
                console.log(columnsforshow)
            }
            $(function () {
                //查询数据库里有哪些试剂盒
                var kits = []
                $.ajax({
                    url: "/pathology/user/data/searchKit",
                    type: "get",
                    success: function (res) {
                        kits = res
                        const fields = kits
                        const titles = kits
                        $.each(fields, (i, v) => {
                            if (i == 0) {
                                $("#filter").append(`
                                  <div class="radio-inline">
                                <label>
                                    <input type="radio" name="optionsRadios" id="optionsRadios1" value="${v}" onclick="showColumns('${v}')"> ${titles[i]}
                                </label>

                            </div>
`)
                                @* onclick="setColumns('${v}')"*@
                            } else {
                                $("#filter").append(`
                                  <div class="radio-inline">
                                <label>
                                    <input type="radio" name="optionsRadios" id="optionsRadios1" value="${v}" onclick="showColumns('${v}')" > ${titles[i]}
                                </label>
                            </div>
`)
                            }
                        })
                    }
                })

                //选择试剂盒 然后发送ajax请求到后台，查到该试剂盒对应的列，以json格式返回，然后bootstraptable重新渲染
            })
            //  点击试剂盒内部的属性(param) 其属性中的列全部选中，否则全反选
            function selectparams(v) {
                // 一个带有value的按钮点击，判断这个value是否checked 是则true，否则false
                let element = $("[data-name='" + v + "']")
                if (element.is(":checked")) {
                    $("[target-name='" + v + "']").prop("checked", true)
                }else{
                    $("[target-name='" + v + "']").prop("checked", false)
                }
            }


            // 确定要查看的列之后提交
            function confirm1() {
                var columns = []
                $.each(columnsforshow, (i, v) => {
                    var obj = {
                        field: v.toLowerCase(),
                        title: v,
                        sortable: true,
                        searchType: "text"
                    }
                    columns.push(obj)
                })
                $("#table").bootstrapTable(
                        "refreshOptions",
                        {
                            url: "@userC.routes.DataController.getMutationTable()",
                            columns: columns
                        }
                )
            }
    </script>

}