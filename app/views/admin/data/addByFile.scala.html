@()(implicit request: play.api.mvc.RequestHeader)
@admin.main("导入文件") {
    <script src="@routes.Assets.at("layer-3.1.1/dist/layer.js")" type="text/javascript"></script>

    <style>
            .form-control {
                display: block;
                width: 100%;
                height: 34px;
                padding: 6px 12px;
                font-size: 14px;
                line-height: 1.42857143;
                color: #555;
                background: #fff none;
                border: 1px solid #ccc;
                border-radius: 4px;
                -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
                box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
                -webkit-transition: border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
                -o-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
                transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            }

    </style>
    <div class="container">
        <form class="registration-form" id="form"
        accept-charset="UTF-8" method="post" style="margin: 20px;" enctype="multipart/form-data">

            <div class="row">
                <div class="form-group col-sm-12">
                    <h2 class="page-heading"
                    style="text-align: left;
                        border-bottom: 5px solid #e9f3f4">导入文件</h2>
                </div>
            </div>

            <div class="row">
                <div class="form-group col-sm-12">
                    <label>数据文件（*.xlsx）:</label>
                    <input id="input-1" type="file" class="file" name="file" data-show-preview="false"
                    data-show-upload="false" accept=".xlsx">
                </div>
            </div>

            <div class="row">
                <div class="form-group col-sm-12">
                    <div class="actions">
                        <input type="button" id="submit" value="更新数据库"
                        class="btn btn-primary btn-lg" onclick="addDataFile()" style="width: 100%">
                    </div>
                </div>

            </div>

        </form>
        <div style="margin: 20px">
            <p>注1：<a href="@routes.ToolController.downloadExampleFile()?fileName=example_data.xlsx" ><b>数据示例文件</b></a>
                。</p>
            <p>注2：数据文件，为Excel文件（Excel 2007以上版本），其中，第一行为表头。</p>
            <p>注3：上传的数据，会完全覆盖数据库中已有的数据。</p>
        </div>

    </div>

    <script>

            $(function () {
                $('#form').bootstrapValidator({
                           /* feedbackIcons: {
                                valid: 'glyphicon glyphicon-ok',
                                invalid: 'glyphicon glyphicon-remove',
                                validating: 'glyphicon glyphicon-refresh'
                            },*/
                            fields: {
                                file : {
                                    validators: {
                                        notEmpty :{
                                            message: "请选择一个数据文件!"
                                        },

                       /*                 file :{
                                            message: "请选择一个Excel(*.xlsx)格式的数据文件！",
                                            extension : "xlsx"
                                        }*/
                                    }
                                }
                            }
                        }
                )
            })
            let time
            function addDataFile() {
                let date = new Date();
                 time = date.getTime();
                var form = $('#form')
                let bv = form.data('bootstrapValidator');

                var valid = bv.isValid()
                if (valid) {
                    let element = "<div id='content'><span id='info'>文件上传中： </span><span id='progress'></span></div>";
                    let index = layer.msg(element, {
                        icon: 16
                        , shade: 0.01,
                        time: 20000000
                    });
                    var formData = document.getElementById("form")
                    $.ajax({
                        url: "/pathology/admin/data/addByFile",
                        type: "post",
                        dataType:"json",
                        processData: false,
                        contentType: false,
                        data: new FormData(form[0]),
                        xhr: function () { //获取ajaxSettings中的xhr对象，为它的upload属性绑定progress事件的处理函数
                            myXhr = $.ajaxSettings.xhr();
                            if (myXhr.upload) { //检查upload属性是否存在
                                //绑定progress事件的回调函数
                                myXhr.upload.addEventListener('progress', progressHandlingFunction, false);
                            }
                            return myXhr; //xhr对象返回给jQuery使用
                        },
                        success: function (res) {
                            alert(res.message)
                            layer.close(index)
                        }
                    })
                }
            }

            function progressHandlingFunction(e) {
                if (e.lengthComputable) {
                    $('#progress').attr({value: e.loaded, max: e.total}); //更新数据到进度条
                    let mydate = new Date();
                    let time1 = mydate.getTime();
                    let speed = (e.loaded / 1024) / ((time1 - time) / 1000);
                    let percent = e.loaded / e.total * 100;
                    console.log(percent)
                    $('#progress').html(percent.toFixed(2) + "%   " + parseInt(speed) + "KB/S");
                    $('#progress').css('width', percent.toFixed(2) + "%");
                }
            }


            $("#input-1").fileinput({
                showPreview: false,
                browseLabel: "选择...",
                removeLabel: "删除文件",
                language: "zh"
            });
    </script>
}