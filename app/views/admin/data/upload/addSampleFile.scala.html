@()(implicit request: play.api.mvc.RequestHeader)
@admin.main("导入文件") {
    <script src="@routes.Assets.at("layer-3.1.1/dist/layer.js")" type="text/javascript"></script>

    <style>
            .form-control {
                display: block;
                width: 100%;
                height: 34px;
                padding: 6px 12px;
                font-size: 14px;
                line-height: 1.42857143;
                color: #555;
                background: #fff none;
                border: 1px solid #ccc;
                border-radius: 4px;
                -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
                box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
                -webkit-transition: border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
                -o-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
                transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            }

    </style>

    @admin.data.upload.nav("导入病理信息表")


    <div class="container">
        <form class="registration-form" id="form"
        accept-charset="UTF-8" method="post" style="" enctype="multipart/form-data">



            <div class="row">
                <div class="form-group col-sm-12" style="margin-top: 30px">
                    <label>数据文件（*.xlsx）:</label>
                    <input id="input-1" type="file" class="file" name="file" data-show-preview="false"
                    data-show-upload="false" accept=".xlsx">
                </div>
            </div>

            <div class="row">

                <div class="form-group col-sm-12">
                    <div class="col-6">
                        <div class="radio">
                            <label>
                                <input type="radio" name="optionsRadios" id="optionsRadios2" value="appendData" checked>
                                在数据后追加数据
                            </label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="radio">
                            <label>
                                <input type="radio" name="optionsRadios" id="optionsRadios1" value="coverData" >
                                覆盖id相同的数据
                            </label>
                        </div>
                    </div>

                </div>

                <div class="form-group col-sm-12">
                    <div class="actions">
                        <input type="button" id="submit" value="更新"
                        class="btn btn-primary btn-lg" onclick="update()" style="width: 132px">
                    </div>
                </div>


            </div>
        </form>
        <div style="">
            <p>注1：<a href="/pathology/tool/downloadExampleFile?filename=sample.xlsx" ><b>数据示例文件</b></a>
                。</p>
            <p>注2：数据文件，为Excel文件（Excel 2007以上版本），其中，第一行为表头。</p>
            <p>注3：上传的数据，会完全覆盖数据库中已有的数据。</p>
        </div>


        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                    &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel">
                            选择上传数据的方式
                        </h4>
                    </div>
                    <div class="modal-body">
                        如果有相同的编号的样本，是否要覆盖数据库原有数据？
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" style="width: 55px" data-dismiss="modal" onclick="coverDataFile()" >yes</button>
                        <button type="button" class="btn btn-primary" style="width: 55px" data-dismiss="modal" onclick="addDataFile()">no</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>

        <div class="form-group" style=" position: relative;
            top: 60px;
        ">
            @*<textarea id="text1" class="form-control" rows="3" style="height: 600px;" ></textarea>*@
            <p>日志</p>
            <pre id="text1" class="form-control" rows="3" style="height: 500px;" readonly ></pre>
        </div>
    </div>


    <script>

            $(function () {
                $("#Sample").addClass("active")
                $('#form').bootstrapValidator({
                            /* feedbackIcons: {
                                 valid: 'glyphicon glyphicon-ok',
                                 invalid: 'glyphicon glyphicon-remove',
                                 validating: 'glyphicon glyphicon-refresh'
                             },*/
                            fields: {
                                file: {
                                    validators: {
                                        notEmpty: {
                                            message: "请选择一个数据文件!"
                                        },

                                        /*                 file :{
                                                             message: "请选择一个Excel(*.xlsx)格式的数据文件！",
                                                             extension : "xlsx"
                                                         }*/
                                    }
                                }
                            }
                        }
                )
            })
            let time

            function addDataFile() {
                let date = new Date();
                time = date.getTime();
                var form = $('#form')
                let bv = form.data('bootstrapValidator');

                var valid = bv.isValid()
                if (valid) {
                    let element = "<div id='content'><span id='info'>文件上传中： </span><span id='progress'></span></div>";
                    var index = layer.msg(element, {
                        icon: 16
                        , shade: 0.01,
                        time: 20000000
                    });
                    var formData = document.getElementById("form")
                    $.ajax({
                        url: "/pathology/admin/data/addSample",
                        type: "post",
                        processData: false,
                        contentType: false,
                        data: new FormData(form[0]),
                        xhr: function () {
                            let myXhr = $.ajaxSettings.xhr();
                            if (myXhr.upload) { //检查upload属性是否存在
                                //绑定progress事件的回调函数
                                let date = new Date();
                                let time = date.getTime();
                                myXhr.upload.addEventListener('progress',  function (e) {
                                    progressHandlingFunction(e, time)
                                }, false);
                            }
                            console.log(myXhr)
                            return myXhr; //xhr对象返回给jQuery使用
                        },
                        success: function (res) {
                            layer.close(index)
                            swal({
                                title: "",
                                text: res.message,
                                icon: "success",
                                button: "Aww yiss!",
                            });
                        },
                        error: function (res) {
                            layer.close(index)
                            swal({
                                title: "",
                                text: res.message,
                                icoin: "error",
                                button: "Aww yiss"
                            })
                        }
                    })
                }
            }

            function progressHandlingFunction(e) {
                if (e.lengthComputable) {
                    $('#progress').attr({value: e.loaded, max: e.total}); //更新数据到进度条
                    let mydate = new Date();
                    let time1 = mydate.getTime();
                    let speed = (e.loaded / 1024) / ((time1 - time) / 1000);
                    let percent = e.loaded / e.total * 100;
                    console.log(percent)
                    $('#progress').html(percent.toFixed(2) + "%   " + parseInt(speed) + "KB/S");
                    $('#progress').css('width', percent.toFixed(2) + "%");
                }
            }

            $("#input-1").fileinput({
                showPreview: false,
                browseLabel: "选择...",
                removeLabel: "删除文件",
                language: "zh"
            });


            function coverDataFile() {
                let date = new Date()
                time = date.getTime()
                var form  = $('#form')
                let bv = form.data('bootstrapValidator')

                var valid = bv.isValid()
                if (valid) {
                    let element = "<div id='content'><span id='info'>文件上传中： </span><span id='progress'></span></div>";
                    let index = layer.msg(element, {
                        icon: 16
                        , shade: 0.01,
                        time: 20000000
                    });
                    var formData = document.getElementById("form")
                    $.ajax({
                        url: "@adminC.routes.DataController.addSampleFileDistinct()",
                        type: "post",
                        processData: false,
                        contentType: false,
                        data: new FormData(form[0]),
                        xhr: function () { //获取ajaxSettings中的xhr对象，为它的upload属性绑定progress事件的处理函数
                            myXhr = $.ajaxSettings.xhr();
                            if (myXhr.upload) { //检查upload属性是否存在
                                //绑定progress事件的回调函数
                                myXhr.upload.addEventListener('progress', progressHandlingFunction, false)
                            }
                            return myXhr; //xhr对象返回给jQuery使用
                        },
                        success: function (res) {
                            let ids = JSON.stringify(res.ids)
                            if(ids == undefined){
                                layer.close(index)
                                swal({
                                    title: "",
                                    text: res.message,
                                    icon: "error",
                                });
                            }else{
                                let dateStr = dateFactory()
                                let idsarr = ids.substring(1, ids.length - 1).split(",").map(x => x.substring(1, x.length - 1)).map(x => dateStr + "      PATIENT_ID" + x + "的数据被覆盖了\n")
                                $("#text1").prepend(idsarr)
                                layer.close(index)
                                swal({
                                    title: "",
                                    text: res.message,
                                    icon: "success",
                                    button: "Aww yiss!",
                                });
                            }
                        },
                        error: function (res) {
                            layer.close(index)
                            swal({
                                title: "",
                                text: res.message,
                                icoin: "error",
                                button: "Aww yiss"
                            })
                        }
                    })
                }
            }

            function update(){
                let value = $('input:radio:checked').val()
                if(value == "coverData"){
                    coverDataFile()
                }else{
                    addDataFile()
                }
            }

            function dateFactory() {
                var nowDate = new Date();
                var year = nowDate.getFullYear();
                var month = nowDate.getMonth() + 1 < 10 ? "0" + (nowDate.getMonth() + 1)
                        : nowDate.getMonth() + 1;
                var day = nowDate.getDate() < 10 ? "0" + nowDate.getDate() : nowDate
                        .getDate();
                var dateStr = year + "-" + month + "-" + day;
                return dateStr
            }
    </script>
}